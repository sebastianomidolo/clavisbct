% Bolla di consegna
% 27 febbraio 2023

\documentclass[a4paper,11pt]{article}

\usepackage[a4paper, top=20mm, bottom=10mm, left=1mm, right=1.25in]{geometry}

\usepackage{fancyhdr}
\setlength{\headheight}{0pt}

\textwidth=21cm
\textheight=29cm

% \rhead{Prova \LaTeX}

\usepackage[utf8x]{inputenc}

% \linespread{1.3}

% \hoffset=-22mm

\usepackage{supertabular}

\renewcommand{\headrulewidth}{0pt}
\pagestyle{fancy}

<%=
 if inputdata.print_mode=='striscioline'
 "\\chead{#{inputdata.titolo_elenco.join('\\\\')} --- da ritagliare --- Stampa: #{Time.now.to_date}}"
 else
 "\\chead{#{inputdata.titolo_elenco.join('\\\\')} --- Stampa: #{Time.now.to_date}}"
 end
%>

\lfoot{}
\cfoot{}
\rfoot{}

\begin{document}



\tablehead{%
\hline
Titolo & Editore & Qtà & Copie &Prezzo & Id \\
\hline}

\tabletail{\hline}

\tablelasttail{\multicolumn{6}{c}{\huge\fbox{Fine <%= "#{inputdata.titolo_elenco.first}" %>}}}

\def\arraystretch{1.5}

\begin{center}
\begin{supertabular}{|p{100mm}|p{22mm}|c|p{22mm}|c|c|}
\hline
<%
 res=[]
 cnt_titoli=cnt_copie=0
 inputdata.each do |e|
   e['titolo'].gsub!("&", '\\\&')
   e['titolo'].gsub!("%", '\\\%')
   e.editore.gsub!("&", '\\\&')
   e.editore.gsub!("%", '\\\%')
   dtl=e.delivery_note_details(inputdata.numerobolla)
   evaso = "#{dtl.evaso}/#{dtl.quantità}"
   qta = dtl.evaso
   cnt_titoli += 1; cnt_copie += qta.to_i
   # evaso = "#{dtl.evaso}"
   # evaso = "#{dtl.evaso}"
   # titolo = "#{e.titolo[0..70]}"
   titolo = e.titolo
   if dtl.note.nil?
     library_codes = '[anomalia]'
   else
     library_codes = dtl.note.split(', ').join(' ')
   end
   if dtl.stato=='Evaso'
     libcod = "{\\rm #{library_codes}}"
   else
     # libcod = "{\\fbox{\\rm #{library_codes}}}"
     libcod = "{\\rm #{library_codes}}"
   end
   if dtl.quantità != dtl.evaso
      # libcod = libcod + " (check)"
   end
   pp = e.clavis_purchase_proposals
   if dtl.note.nil?
     library_codes = '(SIGLE MANCANTI)'
   else
     library_codes = dtl.note.split(', ').join(' ')
   end
   print_alert = false
   pp.each do |i|
     next if !library_codes.include?(i.preferred_library)
     titolo += "\\par\\hfill{{\\fbox{#{i.preferred_library}}} per #{i.patron_barcode}}"
     print_alert = true
     # titolo += "\\par#{library_codes}"
   end

   e.sbct_events.each do |event|
     u = User.find(event.created_by)
     titolo += "\\par\\bf{{Tenere da parte per #{u.clavis_librarian.to_shortlabel}: #{event.name}}}"
     print_alert = true
   end

   # Le note interne è meglio non stamparle in bolla
   e.copie_con_note_interne_e_siglabib_in(library_codes.split.join(',')).each do |nota_interna|
     titolo += "\\par\\bf{{Nota: #{nota_interna}}}"
     print_alert = true
   end

   prezzo = dtl.prezzo
   if e.prezzo!=dtl.prezzo
     titolo += "\\par{\\bf{Correggere prezzo errato su Pac: #{e.prezzo}}"
   end
   if inputdata.print_mode!='striscioline'
     res << "\\raggedright{#{titolo}} & \\raggedright{#{e.editore}} & #{qta} & #{libcod} & #{prezzo} & {\\footnotesize #{e.id}} \\\\"
     res << "\\hline"
   else
     if print_alert
       res << "\\raggedright{#{titolo}} & \\raggedright{#{e.editore}} & #{qta} & #{libcod} & #{prezzo} & {\\footnotesize #{e.id}} \\\\"
       res << "\\hline\\hline"
     end
   end
 end
 if inputdata.print_mode!='striscioline'
   res << " \\raggedleft{{\\bf\\Large{#{cnt_titoli} titoli}}} & & \\raggedleft{{\\bf\\Large{#{cnt_copie}}}} &  &  &  \\\\"
   res << "\\hline"
 end

%>
<%= res.join("\n") %>

\end{supertabular}
\end{center}
\end{document}
